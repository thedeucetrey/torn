<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Undercurrent Game UI - Deep Mining & Economy</title>
<style>
  /* Reset and base styles */
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f0f0;
    color: #222;
  }
  #container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  #banner {
    flex: 0 0 90px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #000;
    position: relative;
  }
  #banner img {
    max-height: 90px;
    width: auto;
  }
  #banner-username-logout {
    position: absolute;
    top: 10px;
    right: 30px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 18px;
    color: white;
  }
  #logout-btn {
    background-color: #facc15;
    border: none;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    color: #162f44;
    transition: background-color 0.3s;
  }
  #logout-btn:hover {
    background-color: #e6b70b;
  }
  #main {
    display: flex;
    flex: 1;
    height: calc(100vh - 90px);
  }
  #toolbar {
    background: #162f44;
    color: #cbd5e1;
    width: 240px;
    padding: 20px 20px 0 20px;
    box-sizing: border-box;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #toolbar-logo {
    width: 140px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px #facc15;
  }
  #toolbar ul {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }
  #toolbar ul li {
    padding: 15px 25px;
    cursor: pointer;
    border-left: 4px solid transparent;
    transition: background-color 0.3s, border-color 0.3s;
    font-weight: 600;
    user-select: none;
  }
  #toolbar ul li:hover {
    background-color: #1f496d;
    border-left-color: #facc15;
    color: #fff;
  }
  #toolbar ul li.active {
    background-color: #facc15;
    color: #162f44;
    border-left-color: #facc15;
  }
  #console {
    background: #fff;
    flex: 1;
    padding: 25px 40px;
    box-sizing: border-box;
    overflow-y: auto;
    box-shadow: inset 0 0 12px #d1d5db;
    font-size: 16px;
  }
  #console h2 {
    margin-top: 0;
    font-weight: 700;
    color: #0b1922;
    border-bottom: 3px solid #facc15;
    padding-bottom: 8px;
    margin-bottom: 20px;
  }
  #console p {
    line-height: 1.5;
  }
  form {
    max-width: 400px;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
  }
  input[type="text"], input[type="password"], input[type="number"], select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
  }
  input[type="submit"], button.action-btn, button.mine-btn {
    margin-top: 20px;
    background-color: #facc15;
    border: none;
    padding: 12px;
    width: 100%;
    border-radius: 6px;
    font-weight: 700;
    font-size: 16px;
    color: #162f44;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  input[type="submit"]:hover, button.action-btn:hover, button.mine-btn:hover {
    background-color: #e6b70b;
  }
  #login-error {
    color: red;
    margin-top: 10px;
  }
  /* Business and mining dashboard styles */
  .business-section {
    max-width: 720px;
    margin: auto;
  }
  .business-header {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 15px;
    color: #0b1922;
  }
  .status-line {
    margin: 12px 0;
  }
  .inventory-list, .supplies-list, .employees-list, .research-list {
    margin: 12px 0 20px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 12px 18px;
    background: #fafafa;
  }
  .inventory-list ul, .supplies-list ul, .employees-list ul, .research-list ul {
    list-style: none;
    padding-left: 0;
  }
  .inventory-list li, .supplies-list li, .employees-list li, .research-list li {
    margin-bottom: 8px;
  }
  .section-title {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: 600;
    font-size: 18px;
    border-bottom: 2px solid #facc15;
    padding-bottom: 6px;
  }
  .inline-inputs {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .inline-inputs input[type=number] {
    width: 90px;
  }
  .log-area {
    margin-top: 20px;
    background: #222;
    color: #facc15;
    padding: 12px;
    border-radius: 6px;
    height: 140px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 14px;
  }
</style>
</head>
<body>
<div id="container">
  <header id="banner" role="banner">
    <img src="undercurrent_banner_728x90.png" alt="Undercurrent Banner" />
    <div id="banner-username-logout" aria-live="polite">
      <div id="username-display"></div>
      <button id="logout-btn" style="display:none;" aria-label="Logout">Logout</button>
    </div>
  </header>
  <div id="main">
    <nav id="toolbar" aria-label="Main Navigation" style="display:none;">
      <img id="toolbar-logo" src="2f1feed3-7496-4292-b14f-0360853a9e0a.png" alt="Undercurrent Logo" />
      <ul id="menu-list"></ul>
    </nav>
    <main id="console" tabindex="0" role="region" aria-live="polite">
      <!-- Content gets dynamically loaded here -->
    </main>
  </div>
</div>

<script>
  // Mock user database with added mining data
  const users = {
    admin: {
      password: 'admin123',
      role: 'admin',
      profile: { username: 'Admin', rank: 'Administrator', level: 99 },
      businesses: []
    },
    player1: {
      password: 'player123',
      role: 'player',
      profile: { username: 'PlayerOne', rank: 'Miner', level: 12 },
      businesses: [
        {
          id: 1,
          name: 'Iron Ore Mining Co.',
          type: 'Mining',
          cash: 75000,
          supplies: { Fuel: 50, Tools: 40, Chemicals: 30 },
          employees: 5,
          employeeEfficiency: 1.0, // Multiplier from research or management
          research: { efficiency: 0.1, quality: 0.05 },
          inventory: { 'Raw Iron Ore': 100, 'Refined Iron Ore': 20 },
          marketShare: 0 // To influence pricing later
        }
      ]
    }
  };

  // Global market data with dynamic pricing based on global supply
  const market = {
    rawIronOre: { basePrice: 50, globalSupply: 500, currentPrice: 50 },
    refinedIronOre: { basePrice: 120, globalSupply: 200, currentPrice: 120 },
    updatePrices: function() {
      // Basic supply-demand pricing: price decreases as supply increases
      this.rawIronOre.currentPrice = Math.max(10, this.rawIronOre.basePrice * (1000 / (1000 + this.rawIronOre.globalSupply)));
      this.refinedIronOre.currentPrice = Math.max(30, this.refinedIronOre.basePrice * (500 / (500 + this.refinedIronOre.globalSupply)));
    }
  };

  const bannerUsername = document.getElementById('username-display');
  const logoutBtn = document.getElementById('logout-btn');
  const toolbar = document.getElementById('toolbar');
  const consoleDiv = document.getElementById('console');
  const menuList = document.getElementById('menu-list');

  const mainMenus = ['Home', 'Profile', 'Mining', 'Market', 'Settings'];

  // Basic templates
  const contentMap = {
    Home: '<h2>Home</h2><p>Welcome to Undercurrent! Explore your mining business and manage resources effectively to grow your empire.</p>',
    Profile: '',
    Settings: '<h2>Settings</h2><p>Configure your preferences and account settings here.</p>',
    Market: '', // dynamically rendered
  };

  // Show login form
  function showLoginForm() {
    toolbar.style.display = 'none';
    logoutBtn.style.display = 'none';
    bannerUsername.textContent = '';
    menuList.innerHTML = '';
    consoleDiv.innerHTML = `
      <h2>Login</h2>
      <form id="login-form" autocomplete="off">
        <label for="username">Username:</label>
        <input id="username" type="text" required autofocus />
        <label for="password">Password:</label>
        <input id="password" type="password" required />
        <input type="submit" value="Login" />
        <div id="login-error"></div>
      </form>
    `;
    document.getElementById('login-form').addEventListener('submit', e => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      authenticateUser(username, password);
    });
  }

  function authenticateUser(username, password) {
    const errorDiv = document.getElementById('login-error');
    if(users[username] && users[username].password === password) {
      localStorage.setItem('loggedInUser', username);
      localStorage.setItem('userRole', users[username].role);
      errorDiv.textContent = '';
      loadUserUI(username, users[username].role);
    } else {
      errorDiv.textContent = 'Invalid username or password.';
    }
  }

  function loadUserUI(username, role) {
    bannerUsername.textContent = `Logged in as: ${username}`;
    logoutBtn.style.display = 'inline-block';
    toolbar.style.display = 'flex';

    menuList.innerHTML = '';
    mainMenus.forEach(menu => {
      const li = document.createElement('li');
      li.textContent = menu;
      li.tabIndex = 0;
      if(menu === 'Home') li.classList.add('active');
      menuList.appendChild(li);
    });
    if(role === 'admin') {
      const adminLi = document.createElement('li');
      adminLi.textContent = 'Admin';
      adminLi.tabIndex = 0;
      menuList.appendChild(adminLi);
    }

    updateConsoleContent('Home', username);
    addMenuListeners(username);
  }

  function addMenuListeners(username) {
    const items = document.querySelectorAll('#menu-list li');
    items.forEach(item => {
      item.addEventListener('click', () => {
        setActiveMenu(item);
        updateConsoleContent(item.textContent, username);
      });
      item.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          item.click();
        }
      });
    });
  }

  function setActiveMenu(selectedItem) {
    const items = document.querySelectorAll('#menu-list li');
    items.forEach(item => item.classList.remove('active'));
    selectedItem.classList.add('active');
  }

  function updateConsoleContent(name, username) {
    if(name === 'Profile') {
      renderProfile(username);
    } else if(name === 'Mining') {
      renderMiningDashboard(username);
    } else if(name === 'Market') {
      renderMarket(username);
    } else if(name === 'Admin') {
      consoleDiv.innerHTML = '<h2>Admin Panel</h2><p>Admin controls go here.</p>';
    } else {
      consoleDiv.innerHTML = contentMap[name] || '<p>Content not available.</p>';
    }
    consoleDiv.focus();
  }

  function renderProfile(username) {
    const p = users[username].profile;
    consoleDiv.innerHTML = `
      <h2>Profile</h2>
      <p><strong>Username:</strong> ${p.username}</p>
      <p><strong>Rank:</strong> ${p.rank}</p>
      <p><strong>Level:</strong> ${p.level}</p>
    `;
  }

  // Render mining dashboard with deep features
  function renderMiningDashboard(username) {
    const biz = users[username].businesses[0];
    if(!biz) {
      consoleDiv.innerHTML = `
        <h2>Mining Business</h2>
        <p>You don't have a mining business yet.</p>
        <button class="action-btn" id="create-mining-btn">Create Iron Ore Mining Business</button>
      `;
      document.getElementById('create-mining-btn').addEventListener('click', () => {
        createMiningBusiness(username);
      });
      return;
    }

    market.updatePrices();

    consoleDiv.innerHTML = `
      <h2>${biz.name}</h2>
      <div class="status-line"><strong>Cash Balance:</strong> $${biz.cash.toLocaleString()}</div>

      <div class="supplies-section">
        <h3 class="section-title">Supplies Inventory</h3>
        <div class="supplies-list">
          <ul>
            <li>Fuel: ${biz.supplies.Fuel}</li>
            <li>Tools: ${biz.supplies.Tools}</li>
            <li>Chemicals: ${biz.supplies.Chemicals}</li>
          </ul>
        </div>
        <button class="action-btn" id="buy-supplies-btn">Buy Supplies (Fuel, Tools, Chemicals for $1000 each)</button>
      </div>

      <div class="employees-section">
        <h3 class="section-title">Employees</h3>
        <p>Number of employees: ${biz.employees}</p>
        <button class="action-btn" id="hire-employee-btn">Hire Employee ($5000 each)</button>
      </div>

      <div class="research-section">
        <h3 class="section-title">Research & Development</h3>
        <p>Efficiency Bonus: ${(biz.research.efficiency * 100).toFixed(1)}%</p>
        <p>Quality Bonus: ${(biz.research.quality * 100).toFixed(1)}%</p>
        <button class="action-btn" id="research-efficiency-btn">Research Efficiency Upgrade ($20,000)</button>
        <button class="action-btn" id="research-quality-btn">Research Quality Upgrade ($20,000)</button>
      </div>

      <div class="inventory-section">
        <h3 class="section-title">Inventory</h3>
        <div class="inventory-list">
          <ul>
            <li>Raw Iron Ore: ${biz.inventory['Raw Iron Ore']}</li>
            <li>Refined Iron Ore: ${biz.inventory['Refined Iron Ore']}</li>
          </ul>
        </div>
      </div>

      <div class="production-controls">
        <button class="mine-btn" id="start-mining-btn">Start Mining Operation (costs supplies and employees)</button>
        <button class="action-btn" id="start-refining-btn">Refine Raw Ore to Refined Ore (costs Chemicals)</button>
      </div>

      <div class="market-price">
        <h3 class="section-title">Market Prices</h3>
        <p>Raw Iron Ore: $${market.rawIronOre.currentPrice.toFixed(2)} per unit (Global Supply: ${market.rawIronOre.globalSupply})</p>
        <p>Refined Iron Ore: $${market.refinedIronOre.currentPrice.toFixed(2)} per unit (Global Supply: ${market.refinedIronOre.globalSupply})</p>
      </div>

      <div class="log-area" id="mining-log" aria-live="polite" aria-atomic="true">
        Mining log will appear here...
      </div>
    `;

    document.getElementById('buy-supplies-btn').addEventListener('click', () => buySupplies(username));
    document.getElementById('hire-employee-btn').addEventListener('click', () => hireEmployee(username));
    document.getElementById('research-efficiency-btn').addEventListener('click', () => researchEfficiency(username));
    document.getElementById('research-quality-btn').addEventListener('click', () => researchQuality(username));
    document.getElementById('start-mining-btn').addEventListener('click', () => startMiningOperation(username));
    document.getElementById('start-refining-btn').addEventListener('click', () => startRefining(username));
  }

  function createMiningBusiness(username) {
    const newBiz = {
      id: Date.now(),
      name: 'Iron Ore Mining Co. ' + Date.now(),
      type: 'Mining',
      cash: 50000,
      supplies: { Fuel: 20, Tools: 20, Chemicals: 10 },
      employees: 3,
      employeeEfficiency: 1.0,
      research: { efficiency: 0.1, quality: 0.05 },
      inventory: { 'Raw Iron Ore': 0, 'Refined Iron Ore': 0 },
      marketShare: 0
    };
    users[username].businesses.push(newBiz);
    updateConsoleContent('Mining', username);
  }

  function buySupplies(username) {
    const biz = users[username].businesses[0];
    if(biz.cash < 3000) {
      alert('Not enough cash to buy all supplies.');
      return;
    }
    biz.cash -= 3000;
    biz.supplies.Fuel += 10;
    biz.supplies.Tools += 10;
    biz.supplies.Chemicals += 10;
    logMiningEvent('Purchased 10 Fuel, Tools, Chemicals for $3000', username);
    updateConsoleContent('Mining', username);
  }

  function hireEmployee(username) {
    const biz = users[username].businesses[0];
    if(biz.cash < 5000) {
      alert('Not enough cash to hire an employee.');
      return;
    }
    biz.cash -= 5000;
    biz.employees += 1;
    logMiningEvent('Hired one employee.', username);
    updateConsoleContent('Mining', username);
  }

  function researchEfficiency(username) {
    const biz = users[username].businesses[0];
    if(biz.cash < 20000) {
      alert('Not enough cash for efficiency research.');
      return;
    }
    biz.cash -= 20000;
    biz.research.efficiency += 0.05; // 5% improvement
    logMiningEvent('Research completed: Efficiency upgraded by 5%.', username);
    updateConsoleContent('Mining', username);
  }

  function researchQuality(username) {
    const biz = users[username].businesses[0];
    if(biz.cash < 20000) {
      alert('Not enough cash for quality research.');
      return;
    }
    biz.cash -= 20000;
    biz.research.quality += 0.03; // 3% improvement
    logMiningEvent('Research completed: Quality upgraded by 3%.', username);
    updateConsoleContent('Mining', username);
  }

  function startMiningOperation(username) {
    const biz = users[username].businesses[0];
    const requiredFuel = 5;
    const requiredTools = 3;
    const employeesNeeded = 1;

    if(biz.supplies.Fuel < requiredFuel || biz.supplies.Tools < requiredTools) {
      alert('Not enough supplies to start mining operation.');
      return;
    }
    if(biz.employees < employeesNeeded) {
      alert('Not enough employees to run mining operation.');
      return;
    }

    // Consume supplies
    biz.supplies.Fuel -= requiredFuel;
    biz.supplies.Tools -= requiredTools;

    // Calculate mined ore amount influenced by employees and research efficiency
    const baseMined = 10;
    const employeeBonus = biz.employees * 2;
    const efficiencyBonus = baseMined * biz.research.efficiency;
    
    let minedAmount = baseMined + employeeBonus + efficiencyBonus;
    minedAmount = Math.floor(minedAmount);

    // Influence global market supply
    market.rawIronOre.globalSupply += minedAmount;

    // Add mined ore to inventory
    biz.inventory['Raw Iron Ore'] += minedAmount;

    logMiningEvent(`Mining operation completed! Mined ${minedAmount} units of Raw Iron Ore.`, username);
    updateConsoleContent('Mining', username);
  }

  function startRefining(username) {
    const biz = users[username].businesses[0];
    const requiredChemicals = 5;
    const rawOreRequired = 10;

    if(biz.supplies.Chemicals < requiredChemicals) {
      alert('Not enough Chemicals to refine ore.');
      return;
    }
    if(biz.inventory['Raw Iron Ore'] < rawOreRequired) {
      alert('Not enough Raw Iron Ore to refine.');
      return;
    }

    // Consume raw ore and chemicals
    biz.supplies.Chemicals -= requiredChemicals;
    biz.inventory['Raw Iron Ore'] -= rawOreRequired;

    // Calculate amount of refined ore produced with quality bonus
    const baseRefined = 8;
    const qualityBonus = baseRefined * biz.research.quality;
    let refinedAmount = baseRefined + qualityBonus;
    refinedAmount = Math.floor(refinedAmount);

    biz.inventory['Refined Iron Ore'] += refinedAmount;

    // Update global supply of refined ore
    market.refinedIronOre.globalSupply += refinedAmount;

    logMiningEvent(`Refined ${rawOreRequired} units of Raw Iron Ore into ${refinedAmount} units of Refined Iron Ore.`, username);
    updateConsoleContent('Mining', username);
  }

  // Logging helper
  function logMiningEvent(message, username) {
    const logArea = document.getElementById('mining-log');
    if(logArea) {
      const timestamp = new Date().toLocaleTimeString();
      const entry = `[${timestamp}] ${message}\n`;
      logArea.textContent = entry + logArea.textContent;
    }
  }

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('loggedInUser');
    localStorage.removeItem('userRole');
    showLoginForm();
  });

  window.onload = function() {
    const username = localStorage.getItem('loggedInUser');
    const role = localStorage.getItem('userRole');
    if(username && role && users[username]) {
      loadUserUI(username, role);
    } else {
      showLoginForm();
    }
  };
</script>
</body>
</html>

